<head>
<meta name="viewport" content="width=device-width height=device-height initial-scale=1.0
                               minimum-scale=1.0 maximum-scale=1.0 user-scalable=no"/>
<title>Thinking for ever</title>
<style typw="text/css">
  a:link{
    color:yellow;
  }
  a:visited{
    color:white;
  }
  .content{
    font-size:1.2em;
    color:green;
    font-weight:bold;
    background-color:transparent;
  }
</style>
<script>
function gen_url(base_url,url){
  if(url.includes("://")){
    return url;
  }else{
    return `${base_url}/${url}`;
  }
}
function blog_file(blog_url){ // Return the URL of main file of blog in blog_url
  return `${blog_url}/blog`;
}
function transform_text(src,content,blog_url,remove_last_line=false){ //src is a text, content is a Node refer, remove_last_line flag whether remove the last line of src, reason in function load_head
  src=src.replace(/\n\r|\n|\r/g,"\n");
  let src_list=[];
  let img_max_width="";
  if(remove_last_line==true){
    src_list=src.split("\n").slice(0,-1).concat(["..."]);
    img_max_width="200px";
  }else{
    src_list=src.split("\n");
    img_max_width="100%";
  }
  for(let line of src_list){
    switch(line[0]){
      case "$": // $img_url
        let img=document.createElement("img");
        img.style.maxWidth=img_max_width;
        img.src=gen_url(blog_url,line.substr(1));
        content.append(img);
        break;
      case "&": // &text=url
        let link=document.createElement("a");
        let x=line.indexOf("=");
        let url=line.substr(x+1);
        let text=line.substr(1,x-1);
        link.style.textDecoration="none";
        link.href=gen_url(blog_url,url);
        link.append(text);
        content.append(link);
        break;
      case "\\":
        line=line.substr(1); // \line escape line as normal text
      default:
        content.append(line);
    }
    content.append(document.createElement("br"));
  }
  content.lastChild.remove();
}
function check_new(path,a,last_visit_time){
  fetch(blog_file(path),{headers:{"If-Modified-Since":last_visit_time}}) 
  //Github Page: Cannot distinguish the time single file's modified. It marks a common last modified time of the site,like:blog.alng.org
  //So their is an Error Usage
  //See more at: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-Modified-Since
  .then(response => {
         if(response.status==200){
           a.style.backgroundColor="rgba(0,0,0,0.5)"; // the new blog
           a.title="This blog has updated after you last visited.";
         }else if(response.status==304){ //HTTP 304 code: the request file has no modified
           a.style.backgroundColor="rgba(255,255,255,0.5)"; // the old blog
           a.title="This blog has no change since you visited.";
         }else{
           /*PASS*/
         }
       });
  return;
}
function UTC_now(){
  let now=new Date();
  return now.toUTCString();
}
function load_head(path,head){// load the header of the blog, so the last line may be incomplete
  fetch(blog_file(path),{headers:{Range:"bytes=0-299"}})
  .then(response => response.text())
  .then(src => {
          transform_text(src.toWellFormed().replace(/\ufffd/g,""),head,path,true);
          return;
      });
}
function load_blog(){
let expire_after_days= days=>(60*60*24*days);
let days=14;
let last_visit_time=document.cookie; // The latest time you had visited this site
document.cookie=`${UTC_now()}; max-age=${expire_after_days(days)}`;
if(last_visit_time!=""){
  document.body.append(`You has visited in ${last_visit_time}`);
}else{
  document.body.append(`Will come,it seems you are first in this site.`);
  last_visit_time="2000-01-01T00:00:00Z";// If you are first in, set a virtual last visit time to mark all blogs are new
}
document.body.append(document.createElement("br"),
`We used cookie to save your last visited time for ${days} days.`);
let tips=document.getElementById("tips");
let blog_url=(new URL(document.location).searchParams).get("url");
let content=document.createElement("div");
content.className="content";
if(blog_url==null){
  fetch("https://api.github.com/repos/alng-org/blog/contents/")
  .then(response => response.json())
  .then(blogs =>{
        tips.remove();
        for(let blog of blogs){
          if(blog.type=="dir"){
            let a=document.createElement("a");
            a.style.textDecoration="none";
            a.style.fontWeight="bold";
            a.style.padding="0.3em";
            a.style.backdropFilter="blur(5px)";
            a.style.borderRadius="10px";
            a.style.display="block";
            a.href=`?url=${blog.path}`;
            let title=document.createElement("span"); //The title of Blog and a few info
            title.append(blog.name);
            a.append(title);
            check_new(blog.path,a,last_visit_time);
            let head=document.createElement("div");
            head.className="content";
            a.append(document.createElement("br"),head);
            load_head(blog.path,head);
            content.append(a,document.createElement("br"),document.createElement("br"));
          }else{
              /*PASS*/
          }
        }
        document.body.append(document.createElement("br"),
                             document.createElement("br"),
                             content);
        return;
      });
}else{
  fetch(blog_file(blog_url))
  .then(response => response.text())
  .then(src => {
          tips.remove();
          let back=document.createElement("a");
          back.href=document.referrer;
          back.style.color="black"; // Functional Node's color,Pending
          back.innerText="Back";
          document.body.append(document.createElement("br"),back);
          content.style.color="aqua";
          transform_text(src,content,blog_url);
          document.body.append(document.createElement("br"),
                               document.createElement("br"),
                               content);
          return;
        });
}
  return;
}
</script>
</head>
<body onload="load_blog()" style="background-image:url(bk_img.jpg);
                                  background-repeat:repeat;
                                  color:white;">
<h1>Welcome to my blog.</h1>
<h5 id="tips">Please wait for loading</h5>
</body>
