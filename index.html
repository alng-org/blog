<head>
<meta name="viewport" content="width=device-width height=device-height initial-scale=1.0
                               minimum-scale=1.0 maximum-scale=1.0 user-scalable=no"/>
<title>Thinking for ever</title>
<style typw="text/css">
  a:link{
    color:yellow;
  }
  a:visited{
    color:skyblue;
  }
</style>
<script>
function gen_url(base_url,url){
  if(url.includes("://")){
    return url;
  }else{
    return `${base_url}/${url}`;
  }
}
function check_new(path,a,last_visit_time){
  fetch(`https://api.github.com/repos/alng-org/blog/commits?path=${path}&per_page=1`)
  .then(response => response.json())
  .then( data => {
         let last_update_time=data[0].commit.committer.date; //get the latest modify timestamp (UTC) of path
         if(Date.parse(last_update_time)>=Date.parse(last_visit_time)){
           a.style.backgroundColor="red"; // the new blog
         }else{
           a.style.backgroundColor="blue"; // the old blog
         }
       });
  return;
}
function UTC_now(){
  let now=new Date();
  return now.toUTCString();
}
function load_blog(){
let expire_after_days= days=>(60*60*24*days);
let days=14;
let last_visit_time=document.cookie; // The latest time you had visited this site
document.cookie=`${UTC_now()}; max-age=${expire_after_days(days)}`;
if(last_visit_time!=""){
  document.body.append(`You has visited in ${last_visit_time}`);
}else{
  document.body.append(`Will come,it seems you are first in this site.`);
  last_visit_time="2000-01-01T00:00:00Z";// If you are first in, set a virtual last visit time to mark all blogs are new
}
document.body.append(document.createElement("br"),
`We used cookie to save your last visited time for ${days} days. The new blog marks by background red, and the old marks by background blue.`);
let tips=document.getElementById("tips");
let blog_url=(new URL(document.location).searchParams).get("url");
let content=document.createElement("div");
content.style.color="lightgreen";
content.style.fontSize="1.2em";
if(blog_url==null){
  fetch("https://api.github.com/repos/alng-org/blog/contents/")
  .then(response => response.json())
  .then(blogs =>{
        tips.remove();
        for(let blog of blogs){
          if(blog.type=="dir"){
            let a=document.createElement("a");
            a.style.textDecoration="none";
            a.style.fontWeight="bold";
            a.style.padding="0.3em";
            a.href=`?url=${blog.path}`;
            a.append(blog.name);
            check_new(blog.path,a,last_visit_time);
            content.append(a,document.createElement("br"),document.createElement("br"));
          }else{
              /*PASS*/
          }
        }
        document.body.append(document.createElement("br"),
                             document.createElement("br"),
                             content);
        return;
      });
}else{
  fetch(`${blog_url}/blog`)
  .then(response => response.text())
  .then(src => {
          tips.remove();
          let back=document.createElement("a");
          back.href=document.referrer;
          back.style.color="orange"; // Functional Node's color,Pending
          back.innerText="Back";
          document.body.append(document.createElement("br"),back);
          src=src.replace(/\n\r|\n|\r/g,"\n");
          for(let line of src.split("\n")){
            switch(line[0]){
              case "$": // $img_url
                let img=document.createElement("img");
                img.style.maxWidth="100%";
                img.src=gen_url(blog_url,line.substr(1));
                content.append(img);
                break;
              case "&": // &text=url
                let link=document.createElement("a");
                let x=line.indexOf("=");
                let url=line.substr(x+1);
                let text=line.substr(1,x);
                link.href=gen_url(blog_url,url);
                link.innerText=text;
                content.append(link);
                break;
              case "\\":
                line=line.substr(1); // \line escape line as normal text
              default:
                content.append(line);
            }
            content.append(document.createElement("br"));
          } 
          document.body.append(document.createElement("br"),
                               document.createElement("br"),
                               content);
          return;
        });
}
  return;
}
</script>
</head>
<body onload="load_blog()">
<h1>Welcome to my blog.</h1>
<h5 id="tips">Please wait for loading</h5>
</body>
